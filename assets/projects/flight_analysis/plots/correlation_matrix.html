<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlation Heatmap</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>
    <style>
        :root {
            --global-bg-color: #ffffff;
            --global-text-color: #000000;
            --chart-bg-color: #ffffff;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--global-bg-color);
            color: var(--global-text-color);
            transition: background 0.3s, color 0.3s;
        }

        body[data-theme="dark"],
        html[data-theme="dark"] {
            --global-bg-color: #000000;
            --global-text-color: #ffffff;
            --chart-bg-color: #000000;
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--chart-bg-color);
            transition: background-color 0.3s;
        }
        .legend-container {
            display: flex;
            flex-direction: row;
            margin-left: 20px;
            height: 400px;
        }
        .color-bar {
            width: 20px;
            background: linear-gradient(to bottom, red, white, blue);
        }
        .legend-values {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding-left: 5px;
            font-size: 12px;
            color: var(--global-text-color);
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <div style="width: 600px; height: 600px;">
            <canvas id="myChart"></canvas>
        </div>
        <div class="legend-container">
            <div class="color-bar"></div>
            <div class="legend-values">
                <span>1.0</span>
                <span>0.5</span>
                <span>0.0</span>
                <span>-0.5</span>
                <span>-1.0</span>
            </div>
        </div>
    </div>
    <script>
        let chart;

        function isDarkMode() {
            if (localStorage.getItem('theme') === 'dark') return true;
            if (document.documentElement.getAttribute('data-theme') === 'dark') return true;
            if (document.body.getAttribute('data-theme') === 'dark') return true;
            if (document.documentElement.classList.contains('dark') || document.body.classList.contains('dark')) return true;
            return false;
        }

        function getThemeColors(dark) {
            if (dark) {
                return {
                    bg: "#000000",
                    text: "#ffffff",
                    borderColor: "rgba(255,255,255,0.2)",
                    tooltipBg: "rgba(0,0,0,0.8)",
                    tooltipBorder: "rgba(255,255,255,0.2)"
                };
            } else {
                return {
                    bg: "#ffffff",
                    text: "#000000",
                    borderColor: "rgba(0,0,0,0.1)",
                    tooltipBg: "rgba(255,255,255,0.8)",
                    tooltipBorder: "rgba(0,0,0,0.1)"
                };
            }
        }

        function applyTheme(dark) {
            if (!chart) return;
            const theme = getThemeColors(dark);

            document.documentElement.style.setProperty('--global-bg-color', theme.bg);
            document.documentElement.style.setProperty('--global-text-color', theme.text);
            document.documentElement.style.setProperty('--chart-bg-color', theme.bg);

            chart.options.plugins.title.color = theme.text;
            chart.options.plugins.tooltip.backgroundColor = theme.tooltipBg;
            chart.options.plugins.tooltip.titleColor = theme.text;
            chart.options.plugins.tooltip.bodyColor = theme.text;
            chart.options.plugins.tooltip.borderColor = theme.tooltipBorder;
            chart.options.scales.x.title.color = theme.text;
            chart.options.scales.y.title.color = theme.text;
            chart.options.scales.x.ticks.color = theme.text;
            chart.options.scales.y.ticks.color = theme.text;

            // Update dataset border color
            chart.data.datasets[0].borderColor = theme.borderColor;

            chart.update();
        }

        const airports = ['ATL', 'DFW', 'DEN', 'ORD', 'LAX'];
        const correlations = [
            [1.0, 0.5, 0.2, -0.1, 0.3],
            [0.5, 1.0, 0.4, 0.6, -0.2],
            [0.2, 0.4, 1.0, 0.3, 0.1],
            [-0.1, 0.6, 0.3, 1.0, 0.7],
            [0.3, -0.2, 0.1, 0.7, 1.0]
        ];
        const dataPoints = [];
        for (let yIdx = 0; yIdx < airports.length; yIdx++) {
            for (let xIdx = 0; xIdx < airports.length; xIdx++) {
                dataPoints.push({
                    x: airports[xIdx],
                    y: airports[yIdx],
                    v: correlations[yIdx][xIdx]
                });
            }
        }

        const dark = isDarkMode();
        const theme = getThemeColors(dark);

        const config = {
            type: 'matrix',
            data: {
                datasets: [{
                    label: 'Correlation Matrix',
                    data: dataPoints,
                    backgroundColor(context) {
                        if (!context.dataset) return;
                        const value = context.dataset.data[context.dataIndex].v;
                        const white = Chart.helpers.color('white');
                        if (value < 0) {
                            return white.mix(Chart.helpers.color('blue'), -value).rgbString();
                        } else {
                            return white.mix(Chart.helpers.color('red'), value).rgbString();
                        }
                    },
                    borderColor: theme.borderColor,
                    borderWidth: 1,
                    width: ({chart}) => (chart.chartArea || {}).width / airports.length - 1,
                    height: ({chart}) => (chart.chartArea || {}).height / airports.length - 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title() {
                                return '';
                            },
                            label(context) {
                                const v = context.dataset.data[context.dataIndex].v;
                                return 'Corr: ' + v.toFixed(2);
                            }
                        },
                        backgroundColor: theme.tooltipBg,
                        titleColor: theme.text,
                        bodyColor: theme.text,
                        borderColor: theme.tooltipBorder,
                        borderWidth: 1
                    },
                    title: {
                        display: true,
                        text: 'Correlation Heatmap for the top 5 airports by total delay',
                        color: theme.text
                    }
                },
                scales: {
                    x: {
                        type: 'category',
                        labels: airports,
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Destination Airport',
                            color: theme.text
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            display: true,
                            color: theme.text
                        }
                    },
                    y: {
                        type: 'category',
                        labels: airports,
                        reverse: true,
                        offset: true,
                        title: {
                            display: true,
                            text: 'Origin Airport',
                            color: theme.text
                        },
                        grid: {
                            display: false
                        },
                        ticks: {
                            display: true,
                            color: theme.text
                        }
                    }
                }
            }
        };
        const ctx = document.getElementById('myChart');
        chart = new Chart(ctx, config);

        // Observe site theme changes
        const observer = new MutationObserver(() => applyTheme(isDarkMode()));
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'data-theme'] });
        observer.observe(document.body, { attributes: true, attributeFilter: ['class', 'data-theme'] });
        window.addEventListener('storage', (event) => { if (event.key === 'theme') applyTheme(isDarkMode()); });
    </script>
</body>
</html>