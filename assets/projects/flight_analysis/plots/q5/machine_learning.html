<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Flight Delay Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #main-plot { width: 900px; height: 500px; margin-bottom: 0px; }
    #plot-select { font-size: 1rem; margin-bottom: 1.5em; }
    .loading { text-align: center; padding: 50px; color: #666; }
    .error { text-align: center; padding: 50px; color: #d32f2f; }
  </style>
</head>
<body>
  <label for="plot-select"><strong>Select a graph:</strong></label>
  <select id="plot-select">
    <option value="metrics">Model Performance Metrics</option>
    <option value="roc_curve">ROC Curves</option>
    <option value="feature_importance_logistic">Feature Importance: Logistic Regression</option>
    <option value="feature_importance_rf">Feature Importance: Random Forest</option>
    <option value="feature_importance_et">Feature Importance: Extra Trees</option>
  </select>

  <div id="main-plot"></div>

  <script>
    // Global variable for ROC curve data
    let rocCurveData = null;

    // ----- Hardcoded Data (all values rounded to 2 decimal places) -----
    const models = ["Logistic Regression", "Random Forest", "Extra Trees"];
    const auc = [0.69, 0.86, 0.81];
    const accuracy = [0.64, 0.76, 0.71];
    const precision = [0.65, 0.75, 0.70];
    const recall = [0.93, 0.91, 0.92];
    const f1_score = [0.76, 0.82, 0.80];

    const featureImportance = {
      'Logistic Regression': {
        features: ["CRSDepHour","IsPeakMonth","IsTopOrigin","IsWeekend","Month","IsTopDest","CRSArrHour","DayOfWeek","DepTime","Origin_encoded","Dest_encoded","ArrTime","EstFlightDuration"],
        values: [-0.42, 0.42, 0.25, -0.16, -0.04, -0.02, -0.01, 0.01, 0.00, 0.00, 0.00, 0.00, 0.00]
      },
      'Random Forest': {
        features: ["ArrTime","CRSArrHour","DepTime","CRSDepHour","EstFlightDuration","Month","Origin_encoded","Dest_encoded","IsPeakMonth","IsTopOrigin","DayOfWeek","IsTopDest","IsWeekend"],
        values: [0.36, 0.19, 0.17, 0.12, 0.06, 0.02, 0.02, 0.02, 0.01, 0.01, 0.01, 0.00, 0.00]
      },
      'Extra Trees': {
        features: ["ArrTime","CRSArrHour","DepTime","CRSDepHour","EstFlightDuration","Month","IsPeakMonth","IsTopOrigin","Origin_encoded","Dest_encoded","DayOfWeek","IsWeekend","IsTopDest"],
        values: [0.32, 0.22, 0.19, 0.15, 0.04, 0.02, 0.02, 0.01, 0.01, 0.01, 0.01, 0.00, 0.00]
      }
    };

    // ----- Plot Functions -----
    function plotMetrics() {
      Plotly.newPlot('main-plot', [
        { x: models, y: auc, name: 'AUC', type: 'bar', hovertemplate: 'AUC: %{y:.2f}<extra></extra>' },
        { x: models, y: accuracy, name: 'Accuracy', type: 'bar', hovertemplate: 'Accuracy: %{y:.2f}<extra></extra>' },
        { x: models, y: precision, name: 'Precision', type: 'bar', hovertemplate: 'Precision: %{y:.2f}<extra></extra>' },
        { x: models, y: recall, name: 'Recall', type: 'bar', hovertemplate: 'Recall: %{y:.2f}<extra></extra>' },
        { x: models, y: f1_score, name: 'F1 Score', type: 'bar', hovertemplate: 'F1 Score: %{y:.2f}<extra></extra>' }
      ], {
        barmode: 'group',
        title: 'Model Performance Metrics',
        yaxis: {
          title: 'Score', 
          range: [0, 1],
          tickformat: '.2f'  // Format y-axis to 2 decimal places
        },
        xaxis: {
          title: 'Models'
        },
        width: 900, 
        height: 500,
        // Custom hover template to show 2 decimal places
        // hovertemplate: '%{fullData.name}: %{y:.2f}<extra></extra>',
        hovermode: 'closest'
      });
    }

    function plotRocCurve() {
      if (!rocCurveData) {
        // Show loading message and start loading ROC data
        Plotly.newPlot('main-plot', [], {
          title: 'ROC Curves',
          xaxis: {title: 'False Positive Rate', tickformat: '.2f'},
          yaxis: {title: 'True Positive Rate', tickformat: '.2f'},
          width: 900, height: 500,
          annotations: [{
            text: 'Loading ROC curve data...',
            showarrow: false,
            x: 0.5,
            y: 0.5,
            xref: 'paper',
            yref: 'paper',
            font: { size: 16, color: '#666' }
          }]
        });

        // Load ROC data using the same pattern as select5_airports.html
        fetch("q5_ml_analysis.json")
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(data => {
            if (!data.roc_curves) {
              throw new Error('ROC curve data not found in JSON');
            }
            
            rocCurveData = data.roc_curves;
            
            // Now plot the ROC curves
            const traces = Object.keys(rocCurveData).map(model => ({
              x: rocCurveData[model].fpr,
              y: rocCurveData[model].tpr,
              mode: 'lines',
              name: `${model} (AUC = ${auc[models.indexOf(model)].toFixed(2)})`, // 2 decimal places
              line: { width: 2 },
              hovertemplate: 'FPR: %{x:.2f}<br>TPR: %{y:.2f}<extra>%{fullData.name}</extra>'
            }));

            // Add diagonal line for reference
            traces.push({
              x: [0, 1],
              y: [0, 1],
              mode: 'lines',
              name: 'Random Classifier',
              line: { dash: 'dash', color: 'gray' },
              hovertemplate: 'FPR: %{x:.2f}<br>TPR: %{y:.2f}<extra>%{fullData.name}</extra>'
            });

            Plotly.newPlot('main-plot', traces, {
              title: 'ROC Curves',
              xaxis: { 
                title: 'False Positive Rate', 
                range: [0, 1], 
                tickformat: '.2f' 
              },
              yaxis: { 
                title: 'True Positive Rate', 
                range: [0, 1], 
                tickformat: '.2f' 
              },
              width: 900, 
              height: 500,
              showlegend: true
            });
          })
          .catch(error => {
            console.error('Error loading ROC data:', error);
            Plotly.newPlot('main-plot', [], {
              title: 'ROC Curves',
              xaxis: {title: 'False Positive Rate', tickformat: '.2f'},
              yaxis: {title: 'True Positive Rate', tickformat: '.2f'},
              width: 900, height: 500,
              annotations: [{
                text: 'Error loading ROC curve data. Please make sure q5_ml_analysis.json is available.',
                showarrow: false,
                x: 0.5,
                y: 0.5,
                xref: 'paper',
                yref: 'paper',
                font: { size: 16, color: '#d32f2f' }
              }]
            });
          });
        
        return; // Exit here, the actual plotting happens in the .then() callback
      }

      // If data is already loaded, plot directly
      const traces = Object.keys(rocCurveData).map(model => ({
        x: rocCurveData[model].fpr,
        y: rocCurveData[model].tpr,
        mode: 'lines',
        name: `${model} (AUC = ${auc[models.indexOf(model)].toFixed(2)})`, // 2 decimal places
        line: { width: 2 },
        hovertemplate: 'FPR: %{x:.2f}<br>TPR: %{y:.2f}<extra>%{fullData.name}</extra>'
      }));

      // Add diagonal line for reference
      traces.push({
        x: [0, 1],
        y: [0, 1],
        mode: 'lines',
        name: 'Random Classifier',
        line: { dash: 'dash', color: 'gray' },
        hovertemplate: 'FPR: %{x:.2f}<br>TPR: %{y:.2f}<extra>%{fullData.name}</extra>'
      });

      Plotly.newPlot('main-plot', traces, {
        title: 'ROC Curves',
        xaxis: { 
          title: 'False Positive Rate', 
          range: [0, 1], 
          tickformat: '.2f' 
        },
        yaxis: { 
          title: 'True Positive Rate', 
          range: [0, 1], 
          tickformat: '.2f' 
        },
        width: 900, 
        height: 500,
        showlegend: true
      });
    }

    function plotFeatureImportance(model) {
      Plotly.newPlot('main-plot', [{
        x: featureImportance[model].values,
        y: featureImportance[model].features,
        type: 'bar',
        orientation: 'h',
        marker: { color: featureImportance[model].values.map(v => v >= 0 ? '#1f77b4' : '#d62728') },
        textposition: 'outside',
      }], {
        title: `${model} Feature Importance`,
        xaxis: { 
          title: 'Importance Score',
          tickformat: '.2f'
        },
        margin: { l: 150 },
        width: 900, 
        height: 500
      });
    }

    // ----- Dropdown Selector -----
    function updatePlot() {
      const plotSelect = document.getElementById('plot-select');
      switch (plotSelect.value) {
        case 'metrics':
          plotMetrics(); 
          break;
        case 'roc_curve':
          plotRocCurve(); 
          break;
        case 'feature_importance_logistic':
          plotFeatureImportance('Logistic Regression'); 
          break;
        case 'feature_importance_rf':
          plotFeatureImportance('Random Forest'); 
          break;
        case 'feature_importance_et':
          plotFeatureImportance('Extra Trees'); 
          break;
      }
    }

    // Initialize immediately since most data is hardcoded
    document.getElementById('plot-select').addEventListener('change', updatePlot);
    
    // Initial plot
    plotMetrics();
  </script>
</body>
</html>