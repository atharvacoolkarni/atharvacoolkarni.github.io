<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Flight Delay Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root {
      --global-bg-color: #ffffff;
      --global-text-color: #000000;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
      background: var(--global-bg-color);
      color: var(--global-text-color);
      transition: background 0s, color 0s;
    }

    body[data-theme="dark"],
    html[data-theme="dark"] {
      --global-bg-color: #000000;
      --global-text-color: #ffffff;
    }

    #main-plot {
      width: 900px;
      height: 500px;
      margin-bottom: 0px;
      background: none;
      border: none;
      box-shadow: none;
      border-radius: 0;
    }

    #plot-select {
      font-size: 1rem;
      margin-bottom: 1.5em;
      background: var(--global-bg-color);
      color: var(--global-text-color);
      border: 1px solid var(--global-text-color);
      padding: 5px;
    }

    .loading { text-align: center; padding: 50px; color: #666; }
    .error { text-align: center; padding: 50px; color: #d32f2f; }
    .hoverlayer .axistext { display: none !important; }
  </style>
</head>
<body>
  <label for="plot-select"><strong>Select a graph:</strong></label>
  <select id="plot-select">
    <option value="metrics">Model Performance Metrics</option>
    <option value="roc_curve">ROC Curves</option>
    <option value="feature_importance_logistic">Feature Importance: Logistic Regression</option>
    <option value="feature_importance_rf">Feature Importance: Random Forest</option>
    <option value="feature_importance_et">Feature Importance: Extra Trees</option>
  </select>

  <div id="main-plot"></div>

  <script>
    // Global variable for ROC curve data
    let rocCurveData = null;

    // Detect global site dark mode (same as hourly_delay_plot.html)
    function isDarkMode() {
      try {
        if (window.parent && window.parent !== window) {
          const parentDoc = window.parent.document;
          if (parentDoc.documentElement.classList.contains('dark') || parentDoc.documentElement.getAttribute('data-theme')==='dark') return true;
          if (parentDoc.body.classList.contains('dark') || parentDoc.body.getAttribute('data-theme')==='dark') return true;
          if (window.parent.localStorage && window.parent.localStorage.getItem('theme')==='dark') return true;
        }
      } catch(e){}
      return document.documentElement.classList.contains('dark') ||
             document.documentElement.getAttribute('data-theme')==='dark' ||
             document.body.classList.contains('dark') ||
             document.body.getAttribute('data-theme')==='dark' ||
             localStorage.getItem('theme')==='dark';
    }

    // Apply theme to Plotly plot and container
    function applyThemeGlobally(plotDiv) {
      const dark = isDarkMode();

      // Update CSS variable for container
      document.documentElement.style.setProperty('--global-bg-color', dark ? '#000000' : '#ffffff');
      document.documentElement.style.setProperty('--global-text-color', dark ? '#ffffff' : '#000000');

      // Update container background
      plotDiv.style.backgroundColor = dark ? '#000000' : '#ffffff';

      // Re-render the current plot with new theme
      const currentPlot = document.getElementById('plot-select').value;
      updatePlotWithTheme(currentPlot, dark);
    }

    // Observe local and parent theme changes
    function observeTheme(plotDiv) {
      const observer = new MutationObserver(() => applyThemeGlobally(plotDiv));

      // Observe local document
      observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class','data-theme'] });
      observer.observe(document.body, { attributes: true, attributeFilter: ['class','data-theme'] });

      // Observe parent site (if exists)
      try {
        if (window.parent && window.parent !== window) {
          const parentDoc = window.parent.document;
          observer.observe(parentDoc.documentElement, { attributes: true, attributeFilter: ['class','data-theme'] });
          observer.observe(parentDoc.body, { attributes: true, attributeFilter: ['class','data-theme'] });
          window.parent.addEventListener('storage', e => { if(e.key==='theme') applyThemeGlobally(plotDiv); });
        }
      } catch(e){}

      // Listen to local storage changes
      window.addEventListener('storage', e => { if(e.key==='theme') applyThemeGlobally(plotDiv); });
    }

    // ----- Hardcoded Data (all values rounded to 2 decimal places) -----
    const models = ["Logistic Regression", "Random Forest", "Extra Trees"];
    const auc = [0.69, 0.86, 0.81];
    const accuracy = [0.64, 0.76, 0.71];
    const precision = [0.65, 0.75, 0.70];
    const recall = [0.93, 0.91, 0.92];
    const f1_score = [0.76, 0.82, 0.80];

    const featureImportance = {
      'Logistic Regression': {
        features: ["CRSDepHour","IsPeakMonth","IsTopOrigin","IsWeekend","Month","IsTopDest","CRSArrHour","DayOfWeek","DepTime","Origin_encoded","Dest_encoded","ArrTime","EstFlightDuration"],
        values: [-0.42, 0.42, 0.25, -0.16, -0.04, -0.02, -0.01, 0.01, 0.00, 0.00, 0.00, 0.00, 0.00]
      },
      'Random Forest': {
        features: ["ArrTime","CRSArrHour","DepTime","CRSDepHour","EstFlightDuration","Month","Origin_encoded","Dest_encoded","IsPeakMonth","IsTopOrigin","DayOfWeek","IsTopDest","IsWeekend"],
        values: [0.36, 0.19, 0.17, 0.12, 0.06, 0.02, 0.02, 0.02, 0.01, 0.01, 0.01, 0.00, 0.00]
      },
      'Extra Trees': {
        features: ["ArrTime","CRSArrHour","DepTime","CRSDepHour","EstFlightDuration","Month","IsPeakMonth","IsTopOrigin","Origin_encoded","Dest_encoded","DayOfWeek","IsWeekend","IsTopDest"],
        values: [0.32, 0.22, 0.19, 0.15, 0.04, 0.02, 0.02, 0.01, 0.01, 0.01, 0.01, 0.00, 0.00]
      }
    };

    // ----- Plot Functions with Theme Support -----
    function plotMetrics(darkMode = isDarkMode()) {
      const metricColors = [
        darkMode ? '#4fc3f7' : '#17a2b8', // AUC - blue
        darkMode ? '#fbc02d' : '#f39c12', // Accuracy - yellow/orange
        darkMode ? '#81c784' : '#28a745', // Precision - green
        darkMode ? '#f06292' : '#dc3545', // Recall - pink/red
        darkMode ? '#ba68c8' : '#6f42c1'  // F1 Score - purple
      ];

      Plotly.newPlot('main-plot', [
        { x: models, y: auc, name: 'AUC', type: 'bar', marker: { color: metricColors[0] }, hovertemplate: 'AUC: %{y:.2f}<extra></extra>' },
        { x: models, y: accuracy, name: 'Accuracy', type: 'bar', marker: { color: metricColors[1] }, hovertemplate: 'Accuracy: %{y:.2f}<extra></extra>' },
        { x: models, y: precision, name: 'Precision', type: 'bar', marker: { color: metricColors[2] }, hovertemplate: 'Precision: %{y:.2f}<extra></extra>' },
        { x: models, y: recall, name: 'Recall', type: 'bar', marker: { color: metricColors[3] }, hovertemplate: 'Recall: %{y:.2f}<extra></extra>' },
        { x: models, y: f1_score, name: 'F1 Score', type: 'bar', marker: { color: metricColors[4] }, hovertemplate: 'F1 Score: %{y:.2f}<extra></extra>' }
      ], {
        barmode: 'group',
        title: { 
          text: 'Model Performance Metrics', 
          font: { color: darkMode ? '#ffffff' : '#000000' } 
        },
        plot_bgcolor: darkMode ? '#000000' : '#ffffff',
        paper_bgcolor: darkMode ? '#000000' : '#ffffff',
        font: { color: darkMode ? '#ffffff' : '#000000' },
        yaxis: {
          title: 'Score', 
          range: [0, 1],
          tickformat: '.2f',
          color: darkMode ? '#ffffff' : '#000000'
        },
        xaxis: {
          title: 'Models',
          color: darkMode ? '#ffffff' : '#000000'
        },
        width: 900, 
        height: 500,
        hovermode: 'closest'
      });
    }

    function plotRocCurve(darkMode = isDarkMode()) {
      if (!rocCurveData) {
        // Show loading message and start loading ROC data
        Plotly.newPlot('main-plot', [], {
          title: { 
            text: 'ROC Curves', 
            font: { color: darkMode ? '#ffffff' : '#000000' } 
          },
          plot_bgcolor: darkMode ? '#000000' : '#ffffff',
          paper_bgcolor: darkMode ? '#000000' : '#ffffff',
          font: { color: darkMode ? '#ffffff' : '#000000' },
          xaxis: {title: 'False Positive Rate', tickformat: '.2f', color: darkMode ? '#ffffff' : '#000000'},
          yaxis: {title: 'True Positive Rate', tickformat: '.2f', color: darkMode ? '#ffffff' : '#000000'},
          width: 900, height: 500,
          annotations: [{
            text: 'Loading ROC curve data...',
            showarrow: false,
            x: 0.5,
            y: 0.5,
            xref: 'paper',
            yref: 'paper',
            font: { size: 16, color: darkMode ? '#ffffff' : '#666666' }
          }]
        });

        // Load ROC data
        fetch("q5_ml_analysis.json")
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(data => {
            if (!data.roc_curves) {
              throw new Error('ROC curve data not found in JSON');
            }
            
            rocCurveData = data.roc_curves;
            plotRocCurveWithData(darkMode);
          })
          .catch(error => {
            console.error('Error loading ROC data:', error);
            Plotly.newPlot('main-plot', [], {
              title: { 
                text: 'ROC Curves', 
                font: { color: darkMode ? '#ffffff' : '#000000' } 
              },
              plot_bgcolor: darkMode ? '#000000' : '#ffffff',
              paper_bgcolor: darkMode ? '#000000' : '#ffffff',
              font: { color: darkMode ? '#ffffff' : '#000000' },
              xaxis: {title: 'False Positive Rate', tickformat: '.2f', color: darkMode ? '#ffffff' : '#000000'},
              yaxis: {title: 'True Positive Rate', tickformat: '.2f', color: darkMode ? '#ffffff' : '#000000'},
              width: 900, height: 500,
              annotations: [{
                text: 'Error loading ROC curve data. Please make sure q5_ml_analysis.json is available.',
                showarrow: false,
                x: 0.5,
                y: 0.5,
                xref: 'paper',
                yref: 'paper',
                font: { size: 16, color: darkMode ? '#ffffff' : '#d32f2f' }
              }]
            });
          });
        
        return;
      }

      plotRocCurveWithData(darkMode);
    }

    function plotRocCurveWithData(darkMode = isDarkMode()) {
      const rocColors = [
        darkMode ? '#4fc3f7' : '#17a2b8', // Logistic Regression - blue
        darkMode ? '#fbc02d' : '#f39c12', // Random Forest - yellow/orange
        darkMode ? '#81c784' : '#28a745'  // Extra Trees - green
      ];

      const traces = Object.keys(rocCurveData).map((model, index) => ({
        x: rocCurveData[model].fpr,
        y: rocCurveData[model].tpr,
        mode: 'lines',
        name: `${model} (AUC = ${auc[models.indexOf(model)].toFixed(2)})`,
        line: { width: 2, color: rocColors[index] },
        hovertemplate: 'FPR: %{x:.2f}<br>TPR: %{y:.2f}<extra>%{fullData.name}</extra>'
      }));

      // Add diagonal line for reference
      traces.push({
        x: [0, 1],
        y: [0, 1],
        mode: 'lines',
        name: 'Random Classifier',
        line: { dash: 'dash', color: darkMode ? '#888888' : '#666666' },
        hovertemplate: 'FPR: %{x:.2f}<br>TPR: %{y:.2f}<extra>%{fullData.name}</extra>'
      });

      Plotly.newPlot('main-plot', traces, {
        title: { 
          text: 'ROC Curves', 
          font: { color: darkMode ? '#ffffff' : '#000000' } 
        },
        plot_bgcolor: darkMode ? '#000000' : '#ffffff',
        paper_bgcolor: darkMode ? '#000000' : '#ffffff',
        font: { color: darkMode ? '#ffffff' : '#000000' },
        xaxis: { 
          title: 'False Positive Rate', 
          range: [0, 1], 
          tickformat: '.2f',
          color: darkMode ? '#ffffff' : '#000000'
        },
        yaxis: { 
          title: 'True Positive Rate', 
          range: [0, 1], 
          tickformat: '.2f',
          color: darkMode ? '#ffffff' : '#000000'
        },
        width: 900, 
        height: 500,
        showlegend: true
      });
    }

    function plotFeatureImportance(model, darkMode = isDarkMode()) {
      const positiveColor = darkMode ? '#4fc3f7' : '#17a2b8';
      const negativeColor = darkMode ? '#f06292' : '#dc3545';

      Plotly.newPlot('main-plot', [{
        x: featureImportance[model].values,
        y: featureImportance[model].features,
        type: 'bar',
        orientation: 'h',
        marker: { color: featureImportance[model].values.map(v => v >= 0 ? positiveColor : negativeColor) },
        textposition: 'outside',
        hovertemplate: '%{y}: %{x:.2f}<extra></extra>'
      }], {
        title: { 
          text: `${model} Feature Importance`, 
          font: { color: darkMode ? '#ffffff' : '#000000' } 
        },
        plot_bgcolor: darkMode ? '#000000' : '#ffffff',
        paper_bgcolor: darkMode ? '#000000' : '#ffffff',
        font: { color: darkMode ? '#ffffff' : '#000000' },
        xaxis: { 
          title: 'Importance Score',
          tickformat: '.2f',
          color: darkMode ? '#ffffff' : '#000000'
        },
        yaxis: {
          color: darkMode ? '#ffffff' : '#000000'
        },
        margin: { l: 150 },
        width: 900, 
        height: 500,
        hoverlabel: {
          bgcolor: darkMode ? '#000000' : '#ffffff',
          font: { color: darkMode ? '#ffffff' : '#000000' },
          bordercolor: darkMode ? '#ffffff' : '#000000'
        }
      });
    }

    // ----- Updated plot function with theme support -----
    function updatePlotWithTheme(plotType, darkMode = isDarkMode()) {
      switch (plotType) {
        case 'metrics':
          plotMetrics(darkMode); 
          break;
        case 'roc_curve':
          plotRocCurve(darkMode); 
          break;
        case 'feature_importance_logistic':
          plotFeatureImportance('Logistic Regression', darkMode); 
          break;
        case 'feature_importance_rf':
          plotFeatureImportance('Random Forest', darkMode); 
          break;
        case 'feature_importance_et':
          plotFeatureImportance('Extra Trees', darkMode); 
          break;
      }
    }

    // ----- Dropdown Selector -----
    function updatePlot() {
      const plotSelect = document.getElementById('plot-select');
      updatePlotWithTheme(plotSelect.value);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      const plotDiv = document.getElementById('main-plot');
      
      // Set up event listener
      document.getElementById('plot-select').addEventListener('change', updatePlot);
      
      // Initial plot with theme detection
      updatePlotWithTheme('metrics');
      
      // Apply initial theme and observe changes
      applyThemeGlobally(plotDiv);
      observeTheme(plotDiv);
    });
  </script>
</body>
</html>