<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Percentage Stacked Bar Plot</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --global-bg-color: #ffffff;
      --global-text-color: #000000;
      --chart-bg-color: #ffffff;
    }

    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--global-bg-color);
      color: var(--global-text-color);
      transition: background 0.3s, color 0.3s;
    }

    body[data-theme="dark"],
    html[data-theme="dark"] {
      --global-bg-color: #000000;
      --global-text-color: #ffffff;
      --chart-bg-color: #000000;
    }

    .chart-container {
      position: relative;
      margin: 0 auto;
      width: 900px;
      height: 500px;
      background-color: var(--chart-bg-color);
      transition: background-color 0.3s;
      overflow: hidden;
    }

    canvas {
      display: block;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="chart-container">
    <canvas id="myChart" width="900" height="500"></canvas>
  </div>

  <script>
    let chart;

    // detect dark mode
    function isDarkMode() {
      // Check parent frame first if we're in an iframe
      try {
        if (window.parent && window.parent !== window) {
          const parentDoc = window.parent.document;
          if (parentDoc.documentElement.getAttribute('data-theme') === 'dark') return true;
          if (parentDoc.body.getAttribute('data-theme') === 'dark') return true;
          if (parentDoc.documentElement.classList.contains('dark') || parentDoc.body.classList.contains('dark')) return true;
          if (window.parent.localStorage && window.parent.localStorage.getItem('theme') === 'dark') return true;
        }
      } catch (e) {
        // Cross-origin restriction, fall back to local checks
      }
      
      // Detect dark mode from local context
      if (localStorage.getItem('theme') === 'dark') return true;
      if (document.documentElement.getAttribute('data-theme') === 'dark') return true;
      if (document.body.getAttribute('data-theme') === 'dark') return true;
      if (document.documentElement.classList.contains('dark') || document.body.classList.contains('dark')) return true;
      return false;
    }

    // theme palettes
    function getThemeColors(dark) {
      if (dark) {
        return {
          bg: "#000000",
          text: "#ffffff",
          grid: "rgba(255,255,255,0.2)",
          dataset: ["#4fc3f7", "#fbc02d"],
          hover: ["#039be5", "#f57f17"]
        };
      } else {
        return {
          bg: "#ffffff",
          text: "#000000",
          grid: "rgba(0,0,0,0.1)",
          dataset: ["#17a2b8", "#dc3545"],
          hover: ["#138496", "#a71d2a"]
        };
      }
    }

    function applyTheme(dark) {
      if (!chart) return;
      const theme = getThemeColors(dark);

      document.documentElement.style.setProperty('--global-bg-color', theme.bg);
      document.documentElement.style.setProperty('--global-text-color', theme.text);
      document.documentElement.style.setProperty('--chart-bg-color', theme.bg);

      chart.options.plugins.title.color = theme.text;
      chart.options.plugins.legend.labels.color = theme.text;
      chart.options.scales.x.ticks.color = theme.text;
      chart.options.scales.y.ticks.color = theme.text;
      chart.options.scales.x.title.color = theme.text;
      chart.options.scales.y.title.color = theme.text;
      chart.options.scales.x.grid.color = theme.grid;
      chart.options.scales.y.grid.color = theme.grid;
      chart.options.backgroundColor = theme.bg;
      chart.options.chartArea = { backgroundColor: theme.bg };
      chart.options.plugins.tooltip.backgroundColor = dark ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.8)';
      chart.options.plugins.tooltip.titleColor = theme.text;
      chart.options.plugins.tooltip.bodyColor = theme.text;
      chart.options.plugins.tooltip.borderColor = dark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';

      chart.data.datasets.forEach((ds, i) => {
        ds.backgroundColor = theme.dataset[i];
        ds.hoverBackgroundColor = theme.hover[i];
      });

      chart.update();
    }

    // Load real dataset
    fetch("select5_airports.json")
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById("myChart").getContext("2d");
        const dark = isDarkMode();
        const theme = getThemeColors(dark);

        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: "2004",
                data: data.datasets[0].data,
                backgroundColor: theme.dataset[0],
                hoverBackgroundColor: theme.hover[0],
                stack: "stack1"
              },
              {
                label: "2005",
                data: data.datasets[1].data,
                backgroundColor: theme.dataset[1],
                hoverBackgroundColor: theme.hover[1],
                stack: "stack1"
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "Percentage stacked bar plot of 5 connections over two years",
                font: { size: 18 },
                color: theme.text
              },
              legend: { labels: { color: theme.text } },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.dataset.label}: ${context.parsed.y}%`;
                  }
                },
                backgroundColor: dark ? "rgba(0,0,0,0.8)" : "rgba(255,255,255,0.8)",
                titleColor: theme.text,
                bodyColor: theme.text,
                borderColor: dark ? "rgba(255,255,255,0.2)" : "rgba(0,0,0,0.1)",
                borderWidth: 1
              }
            },
            scales: {
              x: {
                stacked: true,
                title: { display: true, text: "Connection", color: theme.text },
                ticks: { color: theme.text },
                grid: { color: theme.grid }
              },
              y: {
                stacked: true,
                min: 0,
                max: 100,
                title: { display: true, text: "Percentage", color: theme.text },
                ticks: { color: theme.text, callback: (v) => v + "%" },
                grid: { color: theme.grid }
              }
            },
            backgroundColor: theme.bg,
            chartArea: { backgroundColor: theme.bg }
          }
        });

        // Watch for theme changes
        const observer = new MutationObserver(() => applyTheme(isDarkMode()));
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ["class", "data-theme"] });
        observer.observe(document.body, { attributes: true, attributeFilter: ["class", "data-theme"] });
        
        // Also observe parent frame if available
        try {
          if (window.parent && window.parent !== window) {
            const parentDoc = window.parent.document;
            observer.observe(parentDoc.documentElement, { attributes: true, attributeFilter: ["class", "data-theme"] });
            observer.observe(parentDoc.body, { attributes: true, attributeFilter: ["class", "data-theme"] });
            window.parent.addEventListener("storage", () => applyTheme(isDarkMode()));
          }
        } catch (e) {
          // Cross-origin restriction, can't observe parent
        }
        
        window.addEventListener("storage", () => applyTheme(isDarkMode()));
      });
  </script>
</body>
</html>
