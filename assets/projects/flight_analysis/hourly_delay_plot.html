<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hourly Flight Delay Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--global-bg-color, #eeeeee);
      color: var(--global-text-color, #222831);
      transition: background 0.3s, color 0.3s;
    }

    canvas {
      display: block;
      margin: auto;
    }
  </style>
</head>
<body>

  <canvas id="myChart" width="900" height="500"></canvas>

  <script>
    let chart;

    // Function to detect if the site is in dark mode
    function isDarkMode() {
      // Primary check: GitHub Pages theme system uses data-theme attribute on html element
      return document.documentElement.getAttribute('data-theme') === 'dark';
    }

    // Central theme logic for chart
    function applyTheme(dark) {
      if (!chart) return;

      if (dark) {
        chart.options.plugins.title.color = '#ffffff';
        chart.options.plugins.legend.labels.color = '#ffffff';
        chart.options.scales.x.ticks.color = '#ffffff';
        chart.options.scales.y.ticks.color = '#ffffff';
        chart.options.scales.x.title.color = '#ffffff';
        chart.options.scales.y.title.color = '#ffffff';
        chart.options.scales.x.grid.color = 'rgba(255,255,255,0.2)';
        chart.options.scales.y.grid.color = 'rgba(255,255,255,0.2)';

        chart.data.datasets[0].backgroundColor = '#4fc3f7';
        chart.data.datasets[0].hoverBackgroundColor = '#039be5';
        chart.data.datasets[1].backgroundColor = '#fbc02d';
        chart.data.datasets[1].hoverBackgroundColor = '#f57f17';
      } else {
        chart.options.plugins.title.color = '#000000';
        chart.options.plugins.legend.labels.color = '#000000';
        chart.options.scales.x.ticks.color = '#000000';
        chart.options.scales.y.ticks.color = '#000000';
        chart.options.scales.x.title.color = '#000000';
        chart.options.scales.y.title.color = '#000000';
        chart.options.scales.x.grid.color = 'rgba(0,0,0,0.1)';
        chart.options.scales.y.grid.color = 'rgba(0,0,0,0.1)';

        chart.data.datasets[0].backgroundColor = '#17a2b8';
        chart.data.datasets[0].hoverBackgroundColor = '#138496';
        chart.data.datasets[1].backgroundColor = '#dc3545';
        chart.data.datasets[1].hoverBackgroundColor = '#a71d2a';
      }

      chart.update();
    }

    fetch("hourly_delay_data.json")
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('myChart').getContext('2d');
        const currentDarkMode = isDarkMode();

        // Set initial chart configuration with theme-specific colors
        const chartConfig = {
          type: 'bar',
          data: {
            labels: data.hours,
            datasets: [
              {
                label: 'Departure Delay',
                data: data.departure,
                backgroundColor: currentDarkMode ? '#4fc3f7' : '#17a2b8',
                hoverBackgroundColor: currentDarkMode ? '#039be5' : '#138496',
                barPercentage: 0.7,
                categoryPercentage: 0.8
              },
              {
                label: 'Arrival Delay',
                data: data.arrival,
                backgroundColor: currentDarkMode ? '#fbc02d' : '#dc3545',
                hoverBackgroundColor: currentDarkMode ? '#f57f17' : '#a71d2a',
                barPercentage: 0.7,
                categoryPercentage: 0.8
              }
            ]
          },
          options: {
            responsive: false,
            onClick: (evt, elements) => {
              if (elements.length > 0) {
                const datasetIndex = elements[0].datasetIndex;
                chart.setDatasetVisibility(datasetIndex, !chart.isDatasetVisible(datasetIndex));
                chart.update();
              } else {
                chart.data.datasets.forEach((_, idx) => {
                  chart.setDatasetVisibility(idx, true);
                });
                chart.update();
              }
            },
            onHover: (evt, elements) => {
              evt.native.target.style.cursor = elements.length ? 'pointer' : 'default';
            },
            plugins: {
              title: {
                display: true,
                text: 'Hourly Flight Delay Analysis',
                font: { size: 20 },
                color: currentDarkMode ? '#ffffff' : '#000000'
              },
              legend: { labels: { color: currentDarkMode ? '#ffffff' : '#000000' } },
              tooltip: { enabled: true }
            },
            scales: {
              x: {
                title: { 
                  display: true, 
                  text: 'Hour of Day', 
                  color: currentDarkMode ? '#ffffff' : '#000000' 
                },
                ticks: { color: currentDarkMode ? '#ffffff' : '#000000' },
                grid: { color: currentDarkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)' }
              },
              y: {
                title: { 
                  display: true, 
                  text: 'Average Delay (minutes)', 
                  color: currentDarkMode ? '#ffffff' : '#000000' 
                },
                ticks: { color: currentDarkMode ? '#ffffff' : '#000000' },
                grid: { color: currentDarkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)' }
              }
            }
          }
        };

        chart = new Chart(ctx, chartConfig);

        // Set up observer to watch for theme changes on the html element
        const observerCallback = () => {
          applyTheme(isDarkMode());
        };

        // Watch for attribute changes on the html element (primary method)
        const htmlObserver = new MutationObserver(observerCallback);
        htmlObserver.observe(document.documentElement, { 
          attributes: true, 
          attributeFilter: ['data-theme'] 
        });
      });
  </script>
</body>
</html>